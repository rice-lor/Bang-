<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bang! Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=Rye&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Rye', cursive;
            background-color: #f5deb3; /* Parchment */
            background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
            color: #4a2c12;
        }
        .font-bang { font-family: 'IM Fell English SC', serif; }
        .card {
            border: 2px solid #8B4513;
            background-color: #F5F5DC;
            border-radius: 10px;
            box-shadow: 3px 3px 5px rgba(0,0,0,0.5);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
            width: 100px;
            height: 140px;
            cursor: pointer;
        }
        .card:hover { transform: translateY(-10px) scale(1.05); box-shadow: 5px 10px 15px rgba(0,0,0,0.5); }
        .player-area {
            border: 3px solid #8B4513;
            background-color: rgba(210, 180, 140, 0.7);
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5) inset;
            position: relative;
            min-height: 150px;
        }
        .player-area.active-player { border-color: #FFD700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.8) inset, 0 0 15px rgba(255, 215, 0, 0.8); }
        .player-area.targetable { border-color: #ff4500; cursor: pointer; transform: scale(1.03); }
        .bullet {
            width: 20px;
            height: 20px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path fill="%238B4513" d="M50 0 L60 20 L55 20 L55 80 L60 80 L50 100 L40 80 L45 80 L45 20 L40 20 Z" /><path fill="%23FFD700" d="M50 10 L55 25 L52 25 L52 75 L55 75 L50 90 L45 75 L48 75 L48 25 L45 25 Z" /></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); z-index: 50;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #f5deb3; border: 5px solid #8B4513;
            border-radius: 15px; padding: 2rem; z-index: 60;
            box-shadow: 0 0 30px rgba(0,0,0,0.7); text-align: center;
            max-width: 90%; width: 500px;
        }
        .player-hand { min-height: 150px; }
    </style>
</head>
<body class="p-4">

    <!-- Lobby Screen -->
    <div id="lobby-container" class="container mx-auto p-8 text-center">
        <h1 class="text-6xl font-rye mb-4">Bang! Online</h1>
        <p class="mb-8 font-bang text-xl">The Wild West Card Game</p>
        
        <div class="max-w-md mx-auto bg-tan-200 p-6 rounded-lg shadow-lg border-4 border-yellow-800">
            <div class="mb-4">
                <label for="game-id-input" class="block mb-2">Game ID:</label>
                <input type="text" id="game-id-input" class="p-2 rounded w-full border-2 border-yellow-700 bg-beige" placeholder="Enter Game ID or leave blank for new">
            </div>
            <div class="mb-4">
                <label for="player-name-input" class="block mb-2">Your Name:</label>
                <input type="text" id="player-name-input" class="p-2 rounded w-full border-2 border-yellow-700 bg-beige" placeholder="E.g., Cactus Jack">
            </div>
            <button id="join-game-btn" class="bg-green-800 text-white font-bold py-2 px-4 rounded hover:bg-green-900 transition-colors w-full disabled:opacity-50" disabled>Authenticating...</button>
        </div>
        
        <div id="lobby-players-container" class="mt-8 max-w-md mx-auto hidden">
            <h3 class="text-2xl mb-2">Game Lobby: <span id="game-id-display" class="font-mono text-lg bg-black text-white px-2 py-1 rounded"></span></h3>
            <p class="mb-4">Share the Game ID with your friends!</p>
            <h4 class="text-xl mb-2">Players</h4>
            <ul id="lobby-player-list" class="list-none bg-tan-200 p-4 rounded-lg border-2 border-yellow-700">
                <!-- Player list -->
            </ul>
            <button id="start-game-btn" class="bg-blue-800 text-white font-bold py-2 px-4 rounded hover:bg-blue-900 transition-colors mt-4 hidden">Start Game (Min 4 Players)</button>
        </div>
    </div>


    <!-- Game Screen -->
    <div id="game-container" class="hidden">
        <div id="players-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-4">
            <!-- Player areas will be generated here -->
        </div>

        <div class="fixed bottom-4 right-4 flex flex-col space-y-2">
            <button id="end-turn-btn" class="bg-red-800 text-white font-bold py-2 px-4 rounded hover:bg-red-900 transition-colors">End Turn</button>
            <button id="draw-cards-btn" class="bg-green-800 text-white font-bold py-2 px-4 rounded hover:bg-green-900 transition-colors">Draw 2 Cards</button>
        </div>
        
        <!-- Role Reveal Modal -->
        <div id="role-modal" class="modal-backdrop hidden">
            <div class="modal-content">
                <h2 class="text-3xl font-bang mb-4">Your Role is...</h2>
                <div id="role-reveal-card" class="w-40 h-60 mx-auto border-4 rounded-lg p-4 flex flex-col justify-center items-center bg-beige">
                    <p id="role-name" class="text-4xl"></p>
                    <p id="role-description" class="mt-4 text-sm"></p>
                </div>
                <button id="close-role-modal-btn" class="mt-6 bg-yellow-700 text-white font-bold py-2 px-4 rounded hover:bg-yellow-800">Got It</button>
            </div>
        </div>

        <!-- Info Modal -->
        <div id="info-modal" class="modal-backdrop hidden">
             <div class="modal-content">
                <p id="info-modal-text" class="text-lg"></p>
                <button id="close-info-modal-btn" class="mt-6 bg-yellow-700 text-white font-bold py-2 px-4 rounded hover:bg-yellow-800">OK</button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- FIREBASE CONFIG ---
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIza...", authDomain: "...", projectId: "..." };
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-bang-app';
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- GLOBAL STATE ---
    let userId;
    let currentGameId = null;
    let gameState = {};
    let unsubscribeGame = null;
    let selectedCard = null;

    // --- UI ELEMENTS ---
    const lobbyContainer = document.getElementById('lobby-container');
    const gameContainer = document.getElementById('game-container');
    const joinGameBtn = document.getElementById('join-game-btn');
    const gameIdInput = document.getElementById('game-id-input');
    const playerNameInput = document.getElementById('player-name-input');
    const lobbyPlayersContainer = document.getElementById('lobby-players-container');
    const lobbyPlayerList = document.getElementById('lobby-player-list');
    const gameIdDisplay = document.getElementById('game-id-display');
    const startGameBtn = document.getElementById('start-game-btn');
    const playersContainer = document.getElementById('players-container');
    const roleModal = document.getElementById('role-modal');
    const infoModal = document.getElementById('info-modal');

    // --- MODAL & UTILITY FUNCTIONS ---
    function showInfoModal(message) {
        document.getElementById('info-modal-text').textContent = message;
        infoModal.classList.remove('hidden');
    }
    document.getElementById('close-info-modal-btn').addEventListener('click', () => infoModal.classList.add('hidden'));
    document.getElementById('close-role-modal-btn').addEventListener('click', async () => {
        roleModal.classList.add('hidden');
        if (currentGameId) {
             const gameRef = doc(db, `artifacts/${appId}/public/data/bang_games`, currentGameId);
             await updateDoc(gameRef, { [`players.${userId}.roleShown`]: true });
        }
    });
    
    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // --- AUTHENTICATION ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            userId = user.uid;
            joinGameBtn.disabled = false;
            joinGameBtn.textContent = 'Join / Create Game';
        } else {
            signInAnonymously(auth).catch((error) => console.error("Anonymous sign-in failed:", error));
        }
    });

    // --- LOBBY LOGIC ---
    joinGameBtn.addEventListener('click', async () => {
        const playerName = playerNameInput.value.trim();
        if (!playerName) {
            showInfoModal("Please enter a name!");
            return;
        }

        let gameId = gameIdInput.value.trim() || `game-${Math.random().toString(36).substr(2, 6)}`;
        currentGameId = gameId;
        const gameRef = doc(db, `artifacts/${appId}/public/data/bang_games`, currentGameId);

        try {
            await runTransaction(db, async (transaction) => {
                const gameDoc = await transaction.get(gameRef);
                if (!gameDoc.exists()) {
                    const newGame = {
                        status: 'lobby',
                        hostId: userId,
                        players: { [userId]: { name: playerName } },
                    };
                    transaction.set(gameRef, newGame);
                } else {
                    const gameData = gameDoc.data();
                    if (gameData.status !== 'lobby') throw new Error("This game has already started!");
                    if (Object.keys(gameData.players).length >= 7) throw new Error("This game is full!");
                    
                    const updatePayload = { [`players.${userId}`]: { name: playerName } };
                    transaction.update(gameRef, updatePayload);
                }
            });
            subscribeToGame(currentGameId);
        } catch (error) {
            console.error("Error joining game: ", error);
            showInfoModal(error.message);
        }
    });
    
    function subscribeToGame(gameId) {
        if (unsubscribeGame) unsubscribeGame();
        const gameRef = doc(db, `artifacts/${appId}/public/data/bang_games`, gameId);
        unsubscribeGame = onSnapshot(gameRef, (doc) => {
            if (doc.exists()) {
                gameState = doc.data();
                updateUI(gameState);
            } else {
                showInfoModal("Game not found or has been deleted.");
                // Reset UI to main lobby screen
            }
        });
    }

    function updateUI(state) {
        if (state.status === 'lobby') {
            displayLobby(state);
        } else if (state.status === 'playing') {
            displayGame(state);
        }
    }

    function displayLobby(state) {
        lobbyContainer.querySelector('div').classList.add('hidden'); // Hide join form
        lobbyPlayersContainer.classList.remove('hidden');
        gameContainer.classList.add('hidden');
        gameIdDisplay.textContent = currentGameId;

        lobbyPlayerList.innerHTML = '';
        Object.values(state.players).forEach(player => {
            const li = document.createElement('li');
            li.textContent = player.name;
            lobbyPlayerList.appendChild(li);
        });

        if (userId === state.hostId) {
            startGameBtn.classList.remove('hidden');
            const numPlayers = Object.keys(state.players).length;
            if (numPlayers >= 4) {
                startGameBtn.disabled = false;
                startGameBtn.textContent = 'Start Game';
            } else {
                startGameBtn.disabled = true;
                startGameBtn.textContent = `Need ${4 - numPlayers} more player(s)`;
            }
        }
    }

    startGameBtn.addEventListener('click', async () => {
        const gameRef = doc(db, `artifacts/${appId}/public/data/bang_games`, currentGameId);
        // This setup logic should ideally be in a Cloud Function for security,
        // but for a simple friends game, the host client can do it.
        const playerIds = Object.keys(gameState.players);
        const numPlayers = playerIds.length;
        
        const rolesToAssign = shuffle([...ROLES[numPlayers]]);
        const charactersToAssign = shuffle(Object.values(ALL_CHARACTERS)).slice(0, numPlayers);
        let sheriffIndex = -1;

        let updatedPlayers = {};
        playerIds.forEach((pid, index) => {
            const role = rolesToAssign[index];
            if (role === 'Sheriff') sheriffIndex = index;
            const character = charactersToAssign[index];
            const maxHealth = character.health + (role === 'Sheriff' ? 1 : 0);
            
            updatedPlayers[pid] = {
                ...gameState.players[pid],
                id: pid,
                role: role,
                character: character.name,
                maxHealth: maxHealth,
                health: maxHealth,
                hand: [],
                roleShown: false,
            };
        });
        
        let deck = [];
        Object.entries(ALL_CARDS).forEach(([cardName, cardData]) => {
            for (let i = 0; i < cardData.count; i++) deck.push({ id: `${cardName}_${i}`, name: cardName });
        });
        deck = shuffle(deck);

        Object.values(updatedPlayers).forEach(player => {
            for (let i = 0; i < player.health; i++) player.hand.push(deck.pop());
        });

        await updateDoc(gameRef, {
            status: 'playing',
            players: updatedPlayers,
            deck: deck,
            discardPile: [],
            turnOrder: shuffle(playerIds), // Randomize turn order
            currentTurnIndex: sheriffIndex, // Or start with sheriff
        });
    });

    function displayGame(state) {
        lobbyContainer.classList.add('hidden');
        gameContainer.classList.remove('hidden');

        const me = state.players[userId];
        if (me && !me.roleShown) {
             const roleData = {
                Sheriff: { color: 'blue', desc: 'Kill all Outlaws and the Renegade.'},
                Deputy: { color: 'blue', desc: 'Protect the Sheriff! Kill all Outlaws and the Renegade.'},
                Outlaw: { color: 'red', desc: 'Kill the Sheriff.'},
                Renegade: { color: 'gray', desc: 'Be the last one standing.'},
            };
            document.getElementById('role-name').textContent = me.role;
            document.getElementById('role-description').textContent = roleData[me.role].desc;
            document.getElementById('role-reveal-card').style.borderColor = roleData[me.role].color;
            roleModal.classList.remove('hidden');
        }

        playersContainer.innerHTML = '';
        state.turnOrder.forEach((pid) => {
            const player = state.players[pid];
            const isMe = pid === userId;
            const isCurrentTurn = state.turnOrder[state.currentTurnIndex] === pid;
            
            const playerDiv = document.createElement('div');
            playerDiv.className = `player-area ${isCurrentTurn ? 'active-player' : ''}`;
            playerDiv.dataset.playerId = pid;

            playerDiv.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="font-bold text-lg">${player.name} ${isMe ? '(You)' : ''}</h3>
                        <p class="font-bang text-sm">${player.character}</p>
                        <p class="text-xs font-bold ${player.role === 'Sheriff' ? 'text-blue-800' : 'text-transparent'}">
                           ${player.role === 'Sheriff' ? 'Sheriff' : (isMe ? player.role : '???')}
                        </p>
                    </div>
                    <div class="flex items-center space-x-1">
                         ${[...Array(player.maxHealth)].map((_, i) => `<div class="bullet ${i >= player.health ? 'opacity-20' : ''}"></div>`).join('')}
                    </div>
                </div>
                <div class="mt-2 text-center text-xs">Hand (${player.hand.length})</div>
                <div class="player-hand mt-1 flex flex-wrap gap-1 justify-center">
                    ${isMe ? player.hand.map(card => `<div class="card text-xs flex flex-col justify-center items-center p-1" data-card-id="${card.id}">
                        <span class="font-bang">${card.name}</span>
                    </div>`).join('') : ''}
                </div>
            `;
            playersContainer.appendChild(playerDiv);
        });

        // Add event listeners after rendering
        document.querySelectorAll('.card').forEach(cardEl => cardEl.addEventListener('click', onCardClick));
        document.querySelectorAll('.player-area').forEach(playerEl => playerEl.addEventListener('click', onPlayerClick));
    }
    
    async function updateGameState(updates) {
        const gameRef = doc(db, `artifacts/${appId}/public/data/bang_games`, currentGameId);
        await updateDoc(gameRef, updates);
    }

    async function onCardClick(event) {
        event.stopPropagation();
        const currentTurnPlayerId = gameState.turnOrder[gameState.currentTurnIndex];
        if (userId !== currentTurnPlayerId) return;

        const cardId = event.currentTarget.dataset.cardId;
        const player = gameState.players[userId];
        const card = player.hand.find(c => c.id === cardId);

        selectedCard = { card, player };
        
        if (card.name === 'Bang!') {
             showInfoModal('Bang! Selected. Now click on a target player.');
             document.querySelectorAll('.player-area').forEach(p => p.classList.add('targetable'));
        } else {
             await playCard(card, player);
        }
    }
    
    async function onPlayerClick(event) {
        const targetId = event.currentTarget.dataset.playerId;
        
        if (selectedCard && selectedCard.card.name === 'Bang!' && targetId !== selectedCard.player.id) {
            await playCard(selectedCard.card, selectedCard.player, gameState.players[targetId]);
            document.querySelectorAll('.player-area').forEach(p => p.classList.remove('targetable'));
        }
    }

    async function playCard(card, player, target = null) {
        let newGameState = { ...gameState };
        let playerState = { ...player };
        
        playerState.hand = playerState.hand.filter(c => c.id !== card.id);
        newGameState.discardPile = [...newGameState.discardPile, card];
        
        if (card.name === 'Bang!' && target) {
            newGameState.players[target.id].health--;
        } else if (card.name === 'Beer') {
            playerState.health = Math.min(playerState.maxHealth, playerState.health + 1);
        } else if (card.name === 'Stagecoach') {
            for(let i = 0; i < 2; i++) playerState.hand.push(newGameState.deck.pop());
        }

        newGameState.players[player.id] = playerState;
        selectedCard = null;

        await updateGameState({
            players: newGameState.players,
            deck: newGameState.deck,
            discardPile: newGameState.discardPile
        });
    }

    document.getElementById('draw-cards-btn').addEventListener('click', async () => {
        const currentTurnPlayerId = gameState.turnOrder[gameState.currentTurnIndex];
        if (userId !== currentTurnPlayerId) return;

        let newDeck = [...gameState.deck];
        let newPlayer = { ...gameState.players[userId] };
        for(let i=0; i<2; i++) {
             if (newDeck.length === 0) { // Reshuffle discard pile if deck is empty
                newDeck = shuffle([...gameState.discardPile]);
                await updateGameState({ discardPile: [] });
             }
             if(newDeck.length > 0) newPlayer.hand.push(newDeck.pop());
        }

        await updateGameState({
            [`players.${userId}.hand`]: newPlayer.hand,
            deck: newDeck
        });
    });

    document.getElementById('end-turn-btn').addEventListener('click', async () => {
        const currentTurnPlayerId = gameState.turnOrder[gameState.currentTurnIndex];
        if (userId !== currentTurnPlayerId) return;
        
        const nextTurnIndex = (gameState.currentTurnIndex + 1) % gameState.turnOrder.length;
        await updateGameState({ currentTurnIndex: nextTurnIndex });
    });

    // --- GAME DATA ---
    const ROLES = {
        4: ['Sheriff', 'Renegade', 'Outlaw', 'Outlaw'],
        5: ['Sheriff', 'Renegade', 'Outlaw', 'Outlaw', 'Deputy'],
        6: ['Sheriff', 'Renegade', 'Outlaw', 'Outlaw', 'Outlaw', 'Deputy'],
        7: ['Sheriff', 'Renegade', 'Outlaw', 'Outlaw', 'Outlaw', 'Deputy', 'Deputy'],
    };
    const ALL_CHARACTERS = {
        'bart_cassidy': { name: 'Bart Cassidy', health: 4 }, 'black_jack': { name: 'Black Jack', health: 4 },
        'calamity_janet': { name: 'Calamity Janet', health: 4 }, 'el_gringo': { name: 'El Gringo', health: 3 },
        'jourdonnais': { name: 'Jourdonnais', health: 4 }, 'kit_carlson': { name: 'Kit Carlson', health: 4 },
        'paul_regret': { name: 'Paul Regret', health: 3 }, 'pedro_ramirez': { name: 'Pedro Ramirez', health: 4 },
        'rose_doolan': { name: 'Rose Doolan', health: 4 }, 'sid_ketchum': { name: 'Sid Ketchum', health: 4 },
        'slab_the_killer': { name: 'Slab the Killer', health: 4 }, 'suzy_lafayette': { name: 'Suzy Lafayette', health: 4 },
        'vulture_sam': { name: 'Vulture Sam', health: 4 }, 'willy_the_kid': { name: 'Willy the Kid', health: 4 }
    };
    const ALL_CARDS = {
        'Bang!': { count: 25 }, 'Missed!': { count: 12 }, 'Beer': { count: 6 }, 'Panic!': { count: 4 },
        'Cat Balou': { count: 4 }, 'Stagecoach': { count: 2 }, 'Wells Fargo': { count: 1 }, 'Gatling': { count: 1 },
        'Indians!': { count: 2 }, 'Duel': { count: 3 }, 'Saloon': { count: 1 }, 'Schofield': { count: 3 },
        'Remington': { count: 1 }, 'Rev. Carabine': { count: 1 }, 'Winchester': { count: 1 }, 'Volcanic': { count: 2 },
        'Scope': { count: 1 }, 'Mustang': { count: 2 }, 'Barrel': { count: 2 }, 'Jail': { count: 3 }, 'Dynamite': { count: 1 },
    };
</script>
</body>
</html>

