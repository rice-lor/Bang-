<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bang! Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=Rye&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Rye', cursive;
            background-color: #f5deb3; /* Parchment */
            background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
        }
        .font-bang {
            font-family: 'IM Fell English SC', serif;
        }
        .card {
            border: 2px solid #8B4513; /* SaddleBrown */
            background-color: #F5F5DC; /* Beige */
            border-radius: 10px;
            box-shadow: 3px 3px 5px rgba(0,0,0,0.5);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
            width: 100px;
            height: 140px;
        }
        .card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 5px 10px 15px rgba(0,0,0,0.5);
        }
        .player-area {
            border: 3px solid #8B4513;
            background-color: rgba(210, 180, 140, 0.7); /* Tan with transparency */
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5) inset;
        }
        .player-area.active-player {
            border-color: #FFD700; /* Gold */
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8) inset, 0 0 15px rgba(255, 215, 0, 0.8);
        }
        .bullet {
            width: 20px;
            height: 20px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path fill="%238B4513" d="M50 0 L60 20 L55 20 L55 80 L60 80 L50 100 L40 80 L45 80 L45 20 L40 20 Z" /><path fill="%23FFD700" d="M50 10 L55 25 L52 25 L52 75 L55 75 L50 90 L45 75 L48 75 L48 25 L45 25 Z" /></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        .game-log {
            background-color: rgba(0,0,0,0.7);
            color: white;
            border-radius: 5px;
            padding: 10px;
            height: 150px;
            overflow-y: scroll;
            border: 2px solid #4a2c12;
            font-family: monospace;
            font-size: 0.8rem;
        }
         /* Modal styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 50;
        }
        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #f5deb3;
            border: 5px solid #8B4513;
            border-radius: 15px;
            padding: 2rem;
            z-index: 60;
            box-shadow: 0 0 30px rgba(0,0,0,0.7);
            text-align: center;
        }
    </style>
</head>
<body class="bg-tan-100 text-gray-800">

    <div id="game-container" class="container mx-auto p-4 max-w-7xl hidden">
        
        <!-- Other Players -->
        <div id="other-players-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-4">
            <!-- Other player templates will be inserted here -->
        </div>

        <!-- Central Table -->
        <div class="flex justify-center items-center space-x-8 my-8">
            <div>
                <div id="deck-pile" class="card flex items-center justify-center text-center font-bold text-lg cursor-pointer transform hover:scale-105 transition-transform">
                    BANG!<br/><span id="deck-count" class="text-sm"></span>
                </div>
                <p class="text-center mt-2">Deck</p>
            </div>
            <div>
                <div id="discard-pile" class="card flex items-center justify-center text-center">
                   <!-- Last discarded card will be shown here -->
                </div>
                 <p class="text-center mt-2">Discard</p>
            </div>
            <div id="game-log-container" class="w-1/2">
                 <p class="text-center mb-2">Game Log</p>
                <div id="game-log" class="game-log"></div>
            </div>
        </div>

        <!-- Current Player -->
        <div id="current-player-area" class="fixed bottom-0 left-0 right-0 bg-black bg-opacity-50 p-4">
             <div class="player-area" id="main-player-div">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 id="player-name" class="text-2xl font-bold">Player Name</h2>
                        <p id="player-character" class="text-lg font-bang">Character Name</p>
                        <p id="player-role" class="italic text-sm">Role: Sheriff</p>
                    </div>
                    <div id="player-health" class="flex items-center space-x-1">
                        <!-- Bullets for health -->
                    </div>
                </div>
                <div class="flex mt-2 space-x-4">
                    <div id="player-hand-container" class="flex-1 flex space-x-2 items-end h-[160px]">
                        <!-- Player's cards in hand -->
                    </div>
                    <div class="flex flex-col items-center space-y-2">
                        <button id="end-turn-btn" class="bg-red-800 text-white font-bold py-2 px-4 rounded hover:bg-red-900 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">End Turn</button>
                        <p class="text-xs text-white">Your ID: <span id="user-id-display"></span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lobby -->
    <div id="lobby-container" class="container mx-auto p-8 text-center">
        <h1 class="text-6xl font-rye mb-4">Bang! Online</h1>
        <p class="mb-8 font-bang text-xl">The Wild West Card Game</p>
        
        <div class="max-w-md mx-auto bg-tan-200 p-6 rounded-lg shadow-lg border-4 border-yellow-800">
            <div class="mb-4">
                <label for="game-id-input" class="block mb-2">Game ID:</label>
                <input type="text" id="game-id-input" class="p-2 rounded w-full border-2 border-yellow-700 bg-beige" placeholder="Enter Game ID or leave blank for new">
            </div>
            <div class="mb-4">
                <label for="player-name-input" class="block mb-2">Your Name:</label>
                <input type="text" id="player-name-input" class="p-2 rounded w-full border-2 border-yellow-700 bg-beige" placeholder="E.g., Cactus Jack">
            </div>
            <button id="join-game-btn" class="bg-green-800 text-white font-bold py-2 px-4 rounded hover:bg-green-900 transition-colors w-full">Join / Create Game</button>
        </div>
        
        <div id="lobby-players" class="mt-8 max-w-md mx-auto">
            <h3 class="text-2xl mb-4">Players in Lobby</h3>
            <ul id="lobby-player-list" class="list-disc list-inside bg-tan-200 p-4 rounded-lg border-2 border-yellow-700">
                <!-- Player list -->
            </ul>
            <button id="start-game-btn" class="bg-blue-800 text-white font-bold py-2 px-4 rounded hover:bg-blue-900 transition-colors mt-4 hidden">Start Game (Min 4 Players)</button>
        </div>
    </div>
    
    <!-- Modal for showing role -->
    <div id="role-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-3xl font-bang mb-4">Your Role is...</h2>
            <div id="role-reveal-card" class="w-40 h-60 mx-auto border-4 border-yellow-800 rounded-lg p-4 flex flex-col justify-center items-center bg-beige">
                <p id="role-name" class="text-4xl"></p>
                <p id="role-description" class="mt-4 text-sm"></p>
            </div>
            <button id="close-role-modal-btn" class="mt-6 bg-yellow-700 text-white font-bold py-2 px-4 rounded hover:bg-yellow-800">Got it!</button>
        </div>
    </div>

    <!-- Target Selection Modal -->
    <div id="target-modal" class="modal-backdrop hidden">
        <div id="target-modal-content" class="modal-content">
            <h2 id="target-modal-title" class="text-2xl font-bang mb-4">Select a Target</h2>
            <div id="target-player-list" class="grid grid-cols-2 gap-4">
                <!-- Target player buttons go here -->
            </div>
            <button id="cancel-target-btn" class="mt-6 bg-gray-500 text-white font-bold py-2 px-4 rounded hover:bg-gray-600">Cancel</button>
        </div>
    </div>


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, arrayUnion, arrayRemove, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        // Firebase Config (will be provided by the environment)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIza...", authDomain: "...", projectId: "..." };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-bang-app';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Game state variables
        let userId;
        let currentGameId = null;
        let gameState = null;
        let unsubscribeGame = null;

        // UI Elements
        const lobbyContainer = document.getElementById('lobby-container');
        const gameContainer = document.getElementById('game-container');
        const joinGameBtn = document.getElementById('join-game-btn');
        const gameIdInput = document.getElementById('game-id-input');
        const playerNameInput = document.getElementById('player-name-input');
        const lobbyPlayerList = document.getElementById('lobby-player-list');
        const startGameBtn = document.getElementById('start-game-btn');
        const userIdDisplay = document.getElementById('user-id-display');

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = userId;
                console.log("Authenticated with user ID:", userId);
            } else {
                signInAnonymously(auth).catch((error) => {
                    console.error("Anonymous sign-in failed:", error);
                });
            }
        });

        // --- LOBBY LOGIC ---
        joinGameBtn.addEventListener('click', async () => {
            const playerName = playerNameInput.value.trim();
            if (!playerName) {
                alert("Please enter a name!");
                return;
            }
            if (!userId) {
                alert("Still authenticating, please wait a moment.");
                return;
            }

            let gameId = gameIdInput.value.trim();
            if (!gameId) {
                gameId = `game-${Math.random().toString(36).substr(2, 6)}`;
            }
            
            currentGameId = gameId;
            const gameRef = doc(db, `artifacts/${appId}/public/data/bang_games`, currentGameId);
            
            try {
                const gameDoc = await getDoc(gameRef);

                if (!gameDoc.exists()) {
                    // Create new game
                    await createNewGame(gameRef, playerName);
                } else {
                    // Join existing game
                    const gameData = gameDoc.data();
                    if (gameData.status !== 'lobby') {
                        alert('This game has already started!');
                        return;
                    }
                    if (Object.keys(gameData.players).length >= 7) {
                        alert('This game is full!');
                        return;
                    }
                    const updatePayload = {
                        [`players.${userId}`]: {
                            name: playerName,
                            status: 'active'
                        }
                    };
                    await updateDoc(gameRef, updatePayload);
                }
                
                subscribeToGame(currentGameId);

            } catch (error) {
                console.error("Error joining game: ", error);
                alert("Could not join game. See console for details.");
            }
        });
        
        async function createNewGame(gameRef, playerName) {
            const newGame = {
                status: 'lobby',
                hostId: userId,
                players: {
                    [userId]: {
                        name: playerName,
                        status: 'active' // active, eliminated
                    }
                },
                createdAt: new Date(),
            };
            await setDoc(gameRef, newGame);
            console.log(`New game created with ID: ${gameRef.id}`);
        }

        function subscribeToGame(gameId) {
            const gameRef = doc(db, `artifacts/${appId}/public/data/bang_games`, gameId);
            unsubscribeGame = onSnapshot(gameRef, (doc) => {
                if (doc.exists()) {
                    gameState = doc.data();
                    updateUI(gameState);
                } else {
                    console.log("Game document deleted or does not exist.");
                    alert("The game has ended or could not be found.");
                    resetToLobby();
                }
            });
        }
        
        function updateUI(state) {
            if (state.status === 'lobby') {
                showLobby(state);
            } else if (state.status === 'playing' || state.status === 'gameover') {
                showGame(state);
            }
        }
        
        function showLobby(state) {
            lobbyContainer.classList.remove('hidden');
            gameContainer.classList.add('hidden');
            
            lobbyPlayerList.innerHTML = '';
            const playerIds = Object.keys(state.players);
            playerIds.forEach(pid => {
                const player = state.players[pid];
                const li = document.createElement('li');
                li.textContent = player.name;
                if (pid === userId) li.textContent += " (You)";
                if (pid === state.hostId) li.textContent += " [Host]";
                lobbyPlayerList.appendChild(li);
            });

            if (userId === state.hostId) {
                startGameBtn.classList.remove('hidden');
                if (playerIds.length >= 4) {
                    startGameBtn.disabled = false;
                    startGameBtn.textContent = 'Start Game';
                } else {
                    startGameBtn.disabled = true;
                    startGameBtn.textContent = `Need ${4 - playerIds.length} more player(s)`;
                }
            }
        }
        
        function resetToLobby() {
            if (unsubscribeGame) unsubscribeGame();
            unsubscribeGame = null;
            currentGameId = null;
            gameState = null;
            lobbyContainer.classList.remove('hidden');
            gameContainer.classList.add('hidden');
            gameIdInput.value = '';
            lobbyPlayerList.innerHTML = '';
            startGameBtn.classList.add('hidden');
        }

        startGameBtn.addEventListener('click', async () => {
             if (!currentGameId || userId !== gameState.hostId) return;
             // Here we'd call a cloud function to set up the game securely.
             // For this client-side version, we'll do setup here.
             await setupGame();
        });

        // --- GAME SETUP ---
        const ALL_CARDS = { /* Populated below */ };
        const ALL_CHARACTERS = { /* Populated below */ };
        const ROLES = {
            4: ['Sheriff', 'Renegade', 'Outlaw', 'Outlaw'],
            5: ['Sheriff', 'Renegade', 'Outlaw', 'Outlaw', 'Deputy'],
            6: ['Sheriff', 'Renegade', 'Outlaw', 'Outlaw', 'Outlaw', 'Deputy'],
            7: ['Sheriff', 'Renegade', 'Outlaw', 'Outlaw', 'Outlaw', 'Deputy', 'Deputy'],
        };
        
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        async function setupGame() {
            const gameRef = doc(db, `artifacts/${appId}/public/data/bang_games`, currentGameId);
            const playerIds = Object.keys(gameState.players);
            const numPlayers = playerIds.length;

            if (numPlayers < 4) {
                alert("Need at least 4 players to start.");
                return;
            }

            // 1. Assign Roles
            const rolesToAssign = shuffle([...ROLES[numPlayers]]);
            const shuffledPlayerIds = shuffle([...playerIds]);
            let sheriffId = null;

            const updatedPlayers = {};
            shuffledPlayerIds.forEach((pid, index) => {
                const role = rolesToAssign[index];
                if (role === 'Sheriff') sheriffId = pid;
                updatedPlayers[pid] = {
                    ...gameState.players[pid],
                    role: role,
                    character: null,
                    ability: null,
                    health: 0,
                    maxHealth: 0,
                    hand: [],
                    inPlay: []
                };
            });
            
            // 2. Assign Characters
            const charactersToAssign = shuffle(Object.values(ALL_CHARACTERS)).slice(0, numPlayers);
            shuffledPlayerIds.forEach((pid, index) => {
                const char = charactersToAssign[index];
                updatedPlayers[pid].character = char.name;
                updatedPlayers[pid].ability = char.ability;
                updatedPlayers[pid].maxHealth = char.health + (updatedPlayers[pid].role === 'Sheriff' ? 1 : 0);
                updatedPlayers[pid].health = updatedPlayers[pid].maxHealth;
            });
            
            // 3. Create and shuffle deck
            let deck = [];
            for (const [cardName, cardData] of Object.entries(ALL_CARDS)) {
                for (let i = 0; i < cardData.count; i++) {
                    deck.push({ id: `${cardName}_${i}`, name: cardName });
                }
            }
            deck = shuffle(deck);

            // 4. Deal initial cards
            Object.values(updatedPlayers).forEach(player => {
                for(let i=0; i < player.health; i++) {
                    player.hand.push(deck.pop());
                }
            });

            // 5. Finalize game state for update
            const newGameState = {
                status: 'playing',
                players: updatedPlayers,
                turnOrder: shuffledPlayerIds,
                currentTurnIndex: shuffledPlayerIds.indexOf(sheriffId),
                deck: deck,
                discardPile: [],
                log: [`The game has begun! ${updatedPlayers[sheriffId].name} is the Sheriff.`]
            };
            
            await setDoc(gameRef, newGameState, { merge: true });
        }

        // --- GAME UI RENDERING ---
        function showGame(state) {
            lobbyContainer.classList.add('hidden');
            gameContainer.classList.remove('hidden');

            const myPlayer = state.players[userId];
            if (!myPlayer) {
                console.error("Current user not in game state players object!");
                return;
            }
            
            // Show role modal if not seen yet
            if (!myPlayer.roleShown) {
                showRoleModal(myPlayer.role);
                 // We should ideally set roleShown in Firestore, but this works for a demo
                myPlayer.roleShown = true; 
            }

            // Render current player
            document.getElementById('player-name').textContent = myPlayer.name + (userId === state.turnOrder[state.currentTurnIndex] ? ' (Your Turn)' : '');
            document.getElementById('player-character').textContent = myPlayer.character;
            document.getElementById('player-role').textContent = `Role: ${myPlayer.role}`;
            
            const healthContainer = document.getElementById('player-health');
            healthContainer.innerHTML = '';
            for(let i=0; i < myPlayer.maxHealth; i++) {
                const bulletDiv = document.createElement('div');
                bulletDiv.className = 'bullet';
                if (i >= myPlayer.health) {
                    bulletDiv.style.opacity = '0.2';
                }
                healthContainer.appendChild(bulletDiv);
            }

            // Render player hand
            const handContainer = document.getElementById('player-hand-container');
            handContainer.innerHTML = '';
            myPlayer.hand.forEach(card => {
                const cardEl = createCardElement(card);
                cardEl.addEventListener('click', () => onCardClick(card));
                handContainer.appendChild(cardEl);
            });
            
            // Render other players
            const otherPlayersContainer = document.getElementById('other-players-container');
            otherPlayersContainer.innerHTML = '';
            const myIndex = state.turnOrder.indexOf(userId);
            
            // Simple display order, not table position
            state.turnOrder.forEach((pid, index) => {
                if (pid === userId) return;
                const player = state.players[pid];
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-area';
                 if (index === state.currentTurnIndex) {
                    playerDiv.classList.add('active-player');
                }
                playerDiv.innerHTML = `
                    <h3 class="font-bold text-lg">${player.name}</h3>
                    <p class="font-bang text-sm">${player.character}</p>
                    <p class="text-xs">${player.hand.length} cards in hand</p>
                    <div class="flex mt-1">
                        ${[...Array(player.maxHealth)].map((_, i) => `<div class="bullet ${i >= player.health ? 'opacity-20' : ''}"></div>`).join('')}
                    </div>
                    ${player.status === 'eliminated' ? `<div class="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center text-red-500 text-3xl font-bold">OUT</div><p class="text-center text-white">${player.role}</p>` : ''}
                `;
                otherPlayersContainer.appendChild(playerDiv);
            });
            
            // Update deck and discard
            document.getElementById('deck-count').textContent = `${state.deck.length} cards`;
            const discardPileEl = document.getElementById('discard-pile');
            discardPileEl.innerHTML = '';
            if (state.discardPile.length > 0) {
                const topCard = state.discardPile[state.discardPile.length-1];
                discardPileEl.appendChild(createCardElement(topCard));
            }
            
            // Update game log
            const logEl = document.getElementById('game-log');
            logEl.innerHTML = state.log.join('<br>');
            logEl.scrollTop = logEl.scrollHeight;

            // Enable/disable end turn button
            document.getElementById('end-turn-btn').disabled = (state.turnOrder[state.currentTurnIndex] !== userId);
        }

        function createCardElement(card) {
            const cardData = ALL_CARDS[card.name];
            const div = document.createElement('div');
            div.className = 'card flex flex-col justify-between p-1 cursor-pointer';
            div.innerHTML = `
                <div class="text-left text-sm font-bold">${cardData.value || ''}</div>
                <div class="text-center font-bang text-md">${card.name}</div>
                <div class="text-right text-sm font-bold">${cardData.suit || ''}</div>
            `;
            if (cardData.color === 'blue') {
                div.style.borderColor = '#0000FF';
            }
            return div;
        }
        
        // --- MODAL LOGIC ---
        function showRoleModal(role) {
            const roleData = {
                Sheriff: { color: 'blue', desc: 'Kill all Outlaws and the Renegade.'},
                Deputy: { color: 'blue', desc: 'Protect the Sheriff! Kill all Outlaws and the Renegade.'},
                Outlaw: { color: 'red', desc: 'Kill the Sheriff.'},
                Renegade: { color: 'gray', desc: 'Be the last one standing.'},
            };
            document.getElementById('role-name').textContent = role;
            document.getElementById('role-description').textContent = roleData[role].desc;
            document.getElementById('role-reveal-card').style.borderColor = roleData[role].color;
            document.getElementById('role-modal').classList.remove('hidden');
        }

        document.getElementById('close-role-modal-btn').addEventListener('click', () => {
            document.getElementById('role-modal').classList.add('hidden');
        });
        
        // --- GAME ACTIONS ---
        
        async function onCardClick(card) {
            const myTurn = gameState.turnOrder[gameState.currentTurnIndex] === userId;
            if(!myTurn) {
                console.log("Not your turn!");
                return;
            }
            
            const cardName = card.name;
            console.log(`Clicked on ${cardName}`);

            // This is a simplified action handler. A real one would be much more complex.
            if (cardName === 'Bang!') {
                const targets = getValidTargets('Bang!');
                if (targets.length > 0) {
                    showTargetModal('Bang!', targets, (targetId) => {
                        playCard(card, targetId);
                    });
                } else {
                    alert('No one is in range!');
                }
            } else if (cardName === 'Beer') {
                const me = gameState.players[userId];
                if (me.health < me.maxHealth) {
                    playCard(card, userId);
                } else {
                    alert("You are already at max health!");
                }
            } else {
                alert(`Playing card ${cardName} is not implemented yet.`);
            }
        }
        
        function getValidTargets(cardName) {
            // Very simplified range calculation
            // In Bang, this depends on distance, scopes, mustangs, etc.
            const playerIds = gameState.turnOrder.filter(pid => pid !== userId && gameState.players[pid].status === 'active');
            if (cardName === 'Bang!') {
                // For now, assume everyone is in range of 1
                return playerIds;
            }
            return [];
        }

        function showTargetModal(title, targets, callback) {
            const modal = document.getElementById('target-modal');
            document.getElementById('target-modal-title').textContent = `Select target for ${title}`;
            const targetList = document.getElementById('target-player-list');
            targetList.innerHTML = '';
            
            targets.forEach(pid => {
                const player = gameState.players[pid];
                const btn = document.createElement('button');
                btn.className = 'bg-yellow-700 text-white p-4 rounded hover:bg-yellow-800';
                btn.textContent = player.name;
                btn.onclick = () => {
                    modal.classList.add('hidden');
                    callback(pid);
                };
                targetList.appendChild(btn);
            });
            modal.classList.remove('hidden');
        }

        document.getElementById('cancel-target-btn').addEventListener('click', () => {
            document.getElementById('target-modal').classList.add('hidden');
        });

        async function playCard(card, targetId) {
             console.log(`Playing ${card.name} on ${targetId}`);
             const gameRef = doc(db, `artifacts/${appId}/public/data/bang_games`, currentGameId);

             // IMPORTANT: This should be a transaction or a cloud function to be safe!
             // This client-side logic is insecure and prone to race conditions.
             const me = gameState.players[userId];
             const target = gameState.players[targetId];

             // 1. Remove card from hand
             const newHand = me.hand.filter(c => c.id !== card.id);
             
             // 2. Add card to discard pile
             const newDiscard = [...gameState.discardPile, card];

             // 3. Apply card effect
             let logMessage = `${me.name} played a ${card.name}`;
             const updates = {};
             
             if (card.name === 'Bang!') {
                target.health -= 1;
                logMessage += ` on ${target.name}.`;
             } else if (card.name === 'Beer') {
                me.health = Math.min(me.maxHealth, me.health + 1);
                logMessage += ` and recovered 1 health.`;
             }
             
             updates[`players.${userId}.hand`] = newHand;
             updates[`players.${userId}.health`] = me.health;
             updates[`players.${targetId}.health`] = target.health;
             updates['discardPile'] = newDiscard;
             updates['log'] = arrayUnion(logMessage);

             await updateDoc(gameRef, updates);
        }

        document.getElementById('end-turn-btn').addEventListener('click', async () => {
            const gameRef = doc(db, `artifacts/${appId}/public/data/bang_games`, currentGameId);
            const nextIndex = (gameState.currentTurnIndex + 1) % gameState.turnOrder.length;
            
            // Skip eliminated players
            let finalIndex = nextIndex;
            while(gameState.players[gameState.turnOrder[finalIndex]].status === 'eliminated') {
                finalIndex = (finalIndex + 1) % gameState.turnOrder.length;
            }

            await updateDoc(gameRef, {
                currentTurnIndex: finalIndex,
                log: arrayUnion(`${gameState.players[userId].name} ended their turn. It's now ${gameState.players[gameState.turnOrder[finalIndex]].name}'s turn.`)
            });
        });
        
        // --- GAME DATA DEFINITIONS ---
        Object.assign(ALL_CHARACTERS, {
            'bart_cassidy': { name: 'Bart Cassidy', health: 4, ability: 'Each time he is hit, he draws a card from the deck.' },
            'black_jack': { name: 'Black Jack', health: 4, ability: 'During phase 1 of his turn, he must show the second card he draws. If it is a Heart or Diamond, he draws one additional card.' },
            'calamity_janet': { name: 'Calamity Janet', health: 4, ability: 'She can use Bang! cards as Missed! cards and vice-versa.' },
            'el_gringo': { name: 'El Gringo', health: 3, ability: 'Each time he is hit by a player, he draws a card from the hand of that player.' },
            'jourdonnais': { name: 'Jourdonnais', health: 4, ability: 'He has a Barrel in play at all times.' },
            'kit_carlson': { name: 'Kit Carlson', health: 4, ability: 'During phase 1 of his turn, he looks at the top three cards of the deck, chooses 2 to draw, and puts the other one back on top of the deck.' },
            'paul_regret': { name: 'Paul Regret', health: 3, ability: 'He has a Mustang in play at all times.' },
            'pedro_ramirez': { name: 'Pedro Ramirez', health: 4, ability: 'During the first phase of his turn, he may choose to draw the first card from the top of the discard pile or from the deck.' },
            'rose_doolan': { name: 'Rose Doolan', health: 4, ability: 'She has a Scope in play at all times.' },
            'sid_ketchum': { name: 'Sid Ketchum', health: 4, ability: 'At any time, he may discard 2 cards from his hand to regain one life point.' },
            'slab_the_killer': { name: 'Slab the Killer', health: 4, ability: 'Players trying to cancel his Bang! cards need to play 2 Missed!.' },
            'suzy_lafayette': { name: 'Suzy Lafayette', health: 4, ability: 'As soon as she has no cards in her hand, she draws a card from the deck.' },
            'vulture_sam': { name: 'Vulture Sam', health: 4, ability: 'Whenever a player is eliminated from the game, Sam takes all the cards that player had in his hand and in play.' },
            'willy_the_kid': { name: 'Willy the Kid', health: 4, ability: 'He can play any number of Bang! cards during his turn.' }
        });

        Object.assign(ALL_CARDS, {
            'Bang!': { count: 25, color: 'brown', effect: 'Hit one player in range.' },
            'Missed!': { count: 12, color: 'brown', effect: 'Dodge a Bang!.' },
            'Beer': { count: 6, color: 'brown', effect: 'Regain one life point.' },
            'Panic!': { count: 4, color: 'brown', effect: 'Draw a card from a player at distance 1.' },
            'Cat Balou': { count: 4, color: 'brown', effect: 'Force any player to discard a card.' },
            'Stagecoach': { count: 2, color: 'brown', effect: 'Draw 2 cards.' },
            'Wells Fargo': { count: 1, color: 'brown', effect: 'Draw 3 cards.' },
            'Gatling': { count: 1, color: 'brown', effect: 'Hit all other players.' },
            'Indians!': { count: 2, color: 'brown', effect: 'All other players must discard a Bang! or lose a life point.' },
            'Duel': { count: 3, color: 'brown', effect: 'Challenge another player to a duel.' },
            'Saloon': { count: 1, color: 'brown', effect: 'All players regain one life point.' },
            'Schofield': { count: 3, color: 'blue', type: 'weapon', range: 2 },
            'Remington': { count: 1, color: 'blue', type: 'weapon', range: 3 },
            'Rev. Carabine': { count: 1, color: 'blue', type: 'weapon', range: 4 },
            'Winchester': { count: 1, color: 'blue', type: 'weapon', range: 5 },
            'Volcanic': { count: 2, color: 'blue', type: 'weapon', range: 1, ability: 'Can play any number of Bang! cards.' },
            'Scope': { count: 1, color: 'blue', effect: 'See all players at a distance decreased by 1.' },
            'Mustang': { count: 2, color: 'blue', effect: 'Other players see you at a distance increased by 1.' },
            'Barrel': { count: 2, color: 'blue', effect: 'Draw on a Heart to cancel a Bang!.' },
            'Jail': { count: 3, color: 'blue', effect: 'Put another player in jail.' },
            'Dynamite': { count: 1, color: 'blue', effect: 'Pass it around, if it explodes on you, lose 3 life points.' },
        });

    </script>
</body>
</html>
